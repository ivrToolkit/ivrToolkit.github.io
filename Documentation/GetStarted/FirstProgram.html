---
layout: docs
title: Test
---
<script type="text/javascript">
    var intro = $("#first");
    intro.addClass("active");
    var parentDiv = intro.closest("div");
    parentDiv.addClass("show")
</script>

<div class="bd-intro ps-lg-4">
    <h1 class="bd-title" id="content">Your First SIP/Analog Program</h1>
    <p class="bd-lead">This tutorial will step you through creating a windows service that listens for calls on two SIP
        or Analog lines.</p>
    <p> You can find the source for this example here: <a target="_blank"
            href="https://github.com/ivrToolkit/ivrToolkit/tree/develop/Examples/MyFirstApp">https://github.com/ivrToolkit/ivrToolkit/tree/develop/Examples/MyFirstApp</a>
    </p>
</div>

<div class="bd-toc mt-4 mb-5 my-md-0 ps-xl-3 mb-lg-5 text-muted">
    <strong class="d-block h6 my-2 pb-2 border-bottom">On this page</strong>
    <nav id="TableOfContents">
        <ul>
            <li><a href="#create">Create Application Stub</a>
            <li><a href="#packages">Add Packages</a></li>
            <li><a href="#service">Make it a Windows Service</a>
        </ul>
    </nav>
</div>

<div class="bd-content ps-lg-4">





    <h2 id="create">Create the application stub<a class="anchorjs-link " aria-label="Anchor"
            data-anchorjs-icon="#" href="#create" style="padding-left: 0.375em;"></a></h2>
    <p>Lets start by creating a simple Windows Service. I am going to assume you know how to use the dotnet command
        line.</p>


    <div class="bd-clipboard"><button type="button" class="btn-clipboard" title=""
            data-bs-original-title="Copy to clipboard">Copy</button></div>
    <div class="highlight">
        <pre><code class="language-csharp">md MyFirstApp
cd MyFirstApp
dotnet new sln
dotnet new worker --output MyFirstApp --framework net6.0
dotnet sln add MyFirstApp</code></pre>
    </div>

    <h2 id="packages">Add Packages<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="#"
            href="#packages" style="padding-left: 0.375em;"></a></h2>
    <p>Add the ivrToolkit nuget packages you want to use.</p>



    <div class="bd-clipboard"><button type="button" class="btn-clipboard" title=""
            data-bs-original-title="Copy to clipboard">Copy</button></div>
    <div class="highlight">
        <pre><code class="language-csharp">cd MyFirstApp
dotnet add package ivrToolkit.Core -v 6.0.0-beta-01
dotnet add package ivrToolkit.Plugin.Dialogic.Common -v 6.0.0-beta-01
dotnet add package ivrToolkit.Plugin.Dialogic.Analog -v 6.0.0-beta-01
dotnet add package ivrToolkit.Plugin.Dialogic.Sip -v 6.0.0-beta-01</code></pre>
    </div>

    <h2 id="service">Make it a Windows Service<a class="anchorjs-link " aria-label="Anchor"
            data-anchorjs-icon="#" href="#service" style="padding-left: 0.375em;"></a></h2>
    <p>FYI, this app will run as a console app as well.</p>

    <p>Add the windows service nuget package</p>

    <div class="bd-clipboard"><button type="button" class="btn-clipboard" title=""
            data-bs-original-title="Copy to clipboard">Copy</button></div>
    <div class="highlight">
        <pre><code class="language-csharp">dotnet add package Microsoft.Extensions.Hosting.WindowsServices</code></pre>
    </div>

    <p>add UseWindowsService() to program.cs</p>

    <div class="bd-clipboard"><button type="button" class="btn-clipboard" title=""
            data-bs-original-title="Copy to clipboard">Copy</button></div>
    <div class="highlight">
<pre><code class="language-csharp">using System;
using System.IO;
using ivrToolkit.Plugin.Dialogic.Common;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace MyFirstApp
{
    public class Program
    {
        public static void Main(string[] args)
        {
            CreateHostBuilder(args).Build().Run();
        }

        public static IHostBuilder CreateHostBuilder(string[] args)
        {
            // Make the working directory the location of the EXE file
            Directory.SetCurrentDirectory(AppDomain.CurrentDomain.BaseDirectory);
            return Host.CreateDefaultBuilder(args)

            // set this up as a windows service
            .UseWindowsService()
            .ConfigureServices((_, services) =>
            {
                services.AddHostedService<Worker>();
            });
        }
    }
}</code></pre>
    </div>


    <p>Worker.cs</p>

    <div class="bd-clipboard"><button type="button" class="btn-clipboard" title=""
            data-bs-original-title="Copy to clipboard">Copy</button></div>
    <div class="highlight">
<pre><code class="language-csharp">using System;
using System.Threading;
using System.Threading.Tasks;
using ivrToolkit.Core;
using ivrToolkit.Plugin.Dialogic.Analog;
using ivrToolkit.Plugin.Dialogic.Common;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
    
namespace MyFirstApp
{
    public class Worker : BackgroundService
    {
        private readonly ILoggerFactory _loggerFactory;
        private readonly DialogicVoiceProperties _voiceProperties;
        private readonly ILogger<Worker> _logger;
        private PluginManager _pluginManager;
    
        public Worker(ILoggerFactory loggerFactory, DialogicVoiceProperties voiceProperties)
        {
            _loggerFactory = loggerFactory;
            _voiceProperties = voiceProperties;
            _logger = loggerFactory.CreateLogger<Worker>();
        }
    
        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            await Task.Run(() =>
            {
                _logger.LogInformation("Starting the windows service.");
                try
                {
                    _logger.LogDebug("Starting the Dialogic Analog Plugin");
                    var ivrPlugin = new AnalogPlugin(_loggerFactory, _voiceProperties);
                    _pluginManager = new PluginManager(_loggerFactory, ivrPlugin);
    
                    _logger.LogDebug("Getting line 1");
                    var line1 = _pluginManager.GetLine(1);
                    var waitCall1 = new WaitCall(_loggerFactory, line1, _voiceProperties);
                    var thread1 = new Thread(waitCall1.Run);
    
                    _logger.LogDebug("Getting line 2");
                    var line2 = _pluginManager.GetLine(2);
                    var waitCall2 = new WaitCall(_loggerFactory, line2, _voiceProperties);
                    var thread2 = new Thread(waitCall2.Run);
    
                    thread1.Start();
                    thread2.Start();
                }
                catch (Exception e)
                {
                    _logger.LogError(e, e.Message);
                }
            }, stoppingToken);
        }
    
        public override async Task StopAsync(CancellationToken cancellationToken)
        {
            await Task.Run(() =>
            {
                _pluginManager?.ReleaseAll();
                _pluginManager?.Dispose();
            }, cancellationToken);
        }
    }
    
}</code></pre>
    </div>


        <p>WaitCall.cs</p>

        <div class="bd-clipboard"><button type="button" class="btn-clipboard" title=""
                data-bs-original-title="Copy to clipboard">Copy</button></div>
        <div class="highlight">
<pre><code class="language-csharp">using System;
using System.Threading;
using ivrToolkit.Core;
using ivrToolkit.Core.Exceptions;
using ivrToolkit.Core.Interfaces;
using ivrToolkit.Plugin.Dialogic.Common;
using Microsoft.Extensions.Logging;
using MyFirstApp.ScriptBlocks;
    
namespace MyFirstApp
{
    public class WaitCall
    {
        private readonly ILogger<WaitCall> _logger;
        private readonly ILoggerFactory _loggerFactory;
        private readonly DialogicVoiceProperties _voiceProperties;
        private readonly IIvrLine _line;
    
        public WaitCall(ILoggerFactory loggerFactory, IIvrLine line, DialogicVoiceProperties voiceProperties)
        {
            _voiceProperties = voiceProperties;
            _loggerFactory = loggerFactory;
            _line = line;
            _logger = loggerFactory.CreateLogger<WaitCall>();
        }
    
        public void Run()
        {
            var lineNumber = _line.LineNumber;
            try
            {
                _logger.LogInformation("WaitCall: Line {0}: Got Line", lineNumber);
                while (true)
                {
                    _logger.LogInformation("WaitCall: Line {0}: Hang Up", lineNumber);
                    _line.Hangup();
                    Thread.Sleep(1000);
                    _logger.LogInformation("WaitCall: Line {0}: Wait Rings", lineNumber);
                    _line.WaitRings(1);
    
                    try
                    {
                        var manager = new ScriptManager(_loggerFactory, new WelcomeScript(_loggerFactory, _voiceProperties, _line));
    
                        while (manager.HasNext())
                        {
                            // execute the next script
                            manager.Execute();
                        }
    
                        _line.Hangup();
                    }
                    catch (HangupException)
                    {
                        _line.Hangup();
                    }
    
                }
            }
            catch (DisposingException)
            {
                _logger.LogDebug("DisposingException on line {0}", lineNumber);
                _line.Dispose();
            }
            catch (Exception e)
            {
                _logger.LogError(e, "Exception on line {0}: {1}", lineNumber, e.Message);
            }
        }
    }
}</code></pre>
    </div>






<p>WelcomeScript.cs</p>

<div class="bd-clipboard"><button type="button" class="btn-clipboard" title=""
        data-bs-original-title="Copy to clipboard">Copy</button></div>
<div class="highlight">

<pre><code class="language-csharp">// 
// Copyright 2021 Troy Makaro
// 
// This file is part of ivrToolkit, distributed under the Apache-2.0 license.
// 
// 
    
using ivrToolkit.Core;
using ivrToolkit.Core.Interfaces;
using Microsoft.Extensions.Logging;
    
namespace MyFirstApp.ScriptBlocks
{
    public class WelcomeScript : AbstractScript
    {
        private readonly ILoggerFactory _loggerFactory;
        private readonly VoiceProperties _voiceProperties;
        private readonly IIvrLine _line;
        private readonly ILogger<WelcomeScript> _logger;
    
        public WelcomeScript(ILoggerFactory loggerFactory, VoiceProperties voiceProperties, IIvrLine line) : base(loggerFactory, voiceProperties, line)
        {
            _loggerFactory = loggerFactory;
            _voiceProperties = voiceProperties;
            _line = line;
            _logger = loggerFactory.CreateLogger<WelcomeScript>();
            _logger.LogDebug("Ctr()");
        }
    
        public override string Description => "Welcome";
    
        public override IScript Execute()
        {
            _logger.LogDebug("Execute()");
            // say My welcome message
            Line.PlayFile(@"Voice Files\ThankYou.wav");
            return new MainScript(_loggerFactory, _voiceProperties, _line);
        }
    
    } // class
}</code></pre></div>



<p>GoodbyeScript.cs</p>

<div class="bd-clipboard"><button type="button" class="btn-clipboard" title=""
        data-bs-original-title="Copy to clipboard">Copy</button></div>
<div class="highlight">
<pre><code class="language-csharp">// 
// Copyright 2021 Troy Makaro
// 
// This file is part of ivrToolkit, distributed under the Apache-2.0 license.
// 
// 
    
using ivrToolkit.Core;
using ivrToolkit.Core.Interfaces;
using Microsoft.Extensions.Logging;
    
namespace MyFirstApp.ScriptBlocks
{
    public class GoodbyeScript : AbstractScript
    {
        private readonly ILogger<GoodbyeScript> _logger;
    
        public GoodbyeScript(ILoggerFactory loggerFactory, VoiceProperties voiceProperties, IIvrLine line) : base(loggerFactory, voiceProperties, line)
        {
            _logger = loggerFactory.CreateLogger<GoodbyeScript>();
            _logger.LogDebug("Ctr()");
        }
    
        public override string Description => "Goodbye";
    
        public override IScript Execute()
        {
            _logger.LogDebug("Execute");
            // say my goodbye message
            Line.PlayFile(@"Voice Files\Goodbye.wav");
            return null; // signal the end
        }
    } // class
}</code></pre></div>



</div>